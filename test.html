<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Album Mariage Partag√© üíç</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(150px,1fr));
      gap: 10px;
      margin-top: 20px;
    }
    .media-wrapper {
      position: relative;
      border: 1px solid #ddd;
      padding: 5px;
      border-radius: 8px;
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .media-wrapper img,
    .media-wrapper video {
      width: 100%;
      border-radius: 8px;
      display: block;
    }
    .user-info {
      position: absolute;
      top: 8px;
      left: 8px;
      background: rgba(0,0,0,0.5);
      color: white;
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      backdrop-filter: blur(5px);
      user-select: none;
      pointer-events: none;
    }
    .user-info img {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 8px;
      border: 2px solid white;
    }
  </style>
</head>
<body>

<h1>Album Mariage Partag√© üíç</h1>

<input type="file" id="file-upload" accept="image/*,video/*" multiple />
<button id="upload-btn">Uploader</button>

<div id="gallery"></div>

<script>
  // R√©cup√©ration infos utilisateur depuis localStorage ou valeurs par d√©faut
  const user = JSON.parse(localStorage.getItem('user')) || {
    prenom: 'Invit√©',
    nom: '',
    photo: 'https://via.placeholder.com/28?text=?'
  };

  const cloudName = 'dzfc5vwo0';
  const uploadPreset = 'album_mariage_unsigned'; // Ton preset unsigned Cloudinary

  const backendUrl = 'http://192.168.1.37:3000'; // Ton backend Node.js

  const fileUpload = document.getElementById('file-upload');
  const uploadBtn = document.getElementById('upload-btn');
  const gallery = document.getElementById('gallery');

  let mediaList = [];

  async function loadGallery() {
    try {
      const response = await fetch(`${backendUrl}/gallery`);
      const data = await response.json();
      mediaList = data;
      renderGallery();
    } catch (e) {
      console.error('Erreur lors du chargement de la galerie', e);
      gallery.innerHTML = '<p>Impossible de charger la galerie.</p>';
    }
  }

  function renderGallery() {
    gallery.innerHTML = '';
    mediaList.forEach(url => {
      const wrapper = document.createElement('div');
      wrapper.className = 'media-wrapper';

      // Cr√©ation de la div user-info
      const userInfo = document.createElement('div');
      userInfo.className = 'user-info';

      const userImg = document.createElement('img');
      userImg.src = user.photo;
      userImg.alt = `${user.prenom} ${user.nom}`;

      const userName = document.createElement('span');
      userName.textContent = `${user.prenom} ${user.nom}`;

      userInfo.appendChild(userImg);
      userInfo.appendChild(userName);

      // Cr√©ation du m√©dia
      if (url.match(/\.(mp4|webm|ogg)$/i)) {
        const video = document.createElement('video');
        video.src = url;
        video.controls = true;
        wrapper.appendChild(video);
      } else {
        const img = document.createElement('img');
        img.src = url;
        wrapper.appendChild(img);
      }

      wrapper.appendChild(userInfo);
      gallery.appendChild(wrapper);
    });
  }

  async function sendUrlToBackend(url) {
    try {
      await fetch(`${backendUrl}/upload-url`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url }),
      });
    } catch (error) {
      console.error('Erreur lors de l\'envoi de l\'URL au backend', error);
    }
  }

  async function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', uploadPreset);

    try {
      const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/auto/upload`, {
        method: 'POST',
        body: formData
      });
      const data = await response.json();
      console.log('Upload r√©ussi:', data.secure_url);
      await sendUrlToBackend(data.secure_url);
      await loadGallery();
    } catch (error) {
      alert('Erreur lors de l\'upload');
      console.error(error);
    }
  }

  uploadBtn.addEventListener('click', () => {
    const files = fileUpload.files;
    if (!files.length) {
      alert('Choisis au moins un fichier √† uploader');
      return;
    }
    for (const file of files) {
      uploadFile(file);
    }
    fileUpload.value = ''; // reset input
  });

  // Charge la galerie au d√©marrage
  loadGallery();
</script>

</body>
</html>
